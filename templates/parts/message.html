{% load bleach_tags %}{% load static %}<div class="message{% if message.thread %} reply{% endif %}">
  <div class="header">
    <div class="flags">
      {% if request.user.is_authenticated %}
        {% if not last_visit_time or message.created > last_visit_time %}<img src="{% static "img/new-message.gif" %}">{% endif %}
        <img src="{% static "img/message-icon.gif" %}">
      {% endif %}
    </div>
    <div class="meta">
      <div class="author"><b>od:</b> {{ message.author.username }}</div>
      <div class="recipient"><b>pro:</b> {% if message.recipient %}{{ message.recipient.username }}{% else %}all{% endif %}</div>
      <div class="time">{{ message.created|date:"d.m. H:i" }}</div>
    </div>
  </div>
  <div class="avatar">
    <img src="{% if message.author.avatar %}{{ message.author.avatar.url }}{% else %}{% static "img/rudoksicht.gif" %}{% endif %}">
    <div class="level-{{ message.author.level }}"></div>
  </div>
  <div class="text">{{ message.text|bleach }}</div>
</div>

{% if not message.thread %}
  {% for child_message in message.children.all %}
    {% include "parts/message.html" with message=child_message %}
  {% endfor %}
{% endif %}
